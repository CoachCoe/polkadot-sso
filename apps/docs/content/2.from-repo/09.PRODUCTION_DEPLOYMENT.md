# 🚀 Production Deployment Guide

This guide covers deploying the Polkadot SSO beta to production environments.

## ⚠️ **Beta Warning**

This is a **beta release**. While the core functionality is stable, please:

- Review [BETA_STATUS.md](06.BETA_STATUS.md) for known limitations
- Test thoroughly in staging environments
- Monitor closely after deployment
- Report any issues immediately

---

## 🏗️ **Prerequisites**

### **System Requirements**

- **Node.js**: 18.x or higher
- **Memory**: Minimum 512MB RAM (1GB+ recommended)
- **Storage**: 1GB+ available space
- **Network**: Stable internet connection for blockchain RPC calls

### **Database Options**

- **SQLite** (Default) - File-based, good for small deployments
- **PostgreSQL** (Recommended) - Production-grade, supports high concurrency
- **MySQL** - Alternative to PostgreSQL

### **Blockchain Requirements**

- Access to Polkadot/Kusama RPC endpoints
- Consider using multiple RPC providers for redundancy

---

## 🔧 **Environment Configuration**

### **1. Generate Secure Secrets**

```bash
# Generate strong secrets (32+ characters each)
node -e "console.log('JWT_ACCESS_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
node -e "console.log('JWT_REFRESH_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
node -e "console.log('SESSION_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
node -e "console.log('ENCRYPTION_KEY=' + require('crypto').randomBytes(32).toString('hex'))"
```

### **2. Required Environment Variables**

```bash
# Core Security (REQUIRED)
JWT_ACCESS_SECRET=your-32-char-secret-key-here
JWT_REFRESH_SECRET=your-32-char-secret-key-here
SESSION_SECRET=your-32-char-secret-key-here
ENCRYPTION_KEY=your-32-char-secret-key-here

# Environment
NODE_ENV=production

# Server Configuration
PORT=3001
HOST=0.0.0.0

# Database (choose one)
DATABASE_TYPE=postgresql
DATABASE_HOST=your-db-host
DATABASE_PORT=5432
DATABASE_NAME=polkadot_sso
DATABASE_USERNAME=your-db-user
DATABASE_PASSWORD=your-db-password
DATABASE_SSL=true

# Or for SQLite (development only)
# DATABASE_TYPE=sqlite
# DATABASE_PATH=/var/lib/polkadot-sso/sso.db
```

### **3. Optional Configuration**

```bash
# Remittance Platform
REMITANCE_ENABLED=true
REMITANCE_TREASURY_ADDRESS=5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY

# Exchange Rates
EXCHANGE_RATE_PROVIDER=coingecko
COINGECKO_API_KEY=your-coingecko-api-key

# Chain Configuration
DEFAULT_CHAIN=kusama
KUSAMA_RPC_URL=wss://kusama-rpc.polkadot.io
POLKADOT_RPC_URL=wss://rpc.polkadot.io

# Security Features
ENABLE_SIGNATURE_VERIFICATION=true
ENABLE_RATE_LIMITING=true
ENABLE_CORS=true
ENABLE_HELMET=true
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com

# Logging
LOG_LEVEL=info
LOG_ENABLE_FILE=true
LOG_FILE_PATH=/var/log/polkadot-sso/app.log
```

---

## 🐳 **Docker Deployment**

### **1. Create Dockerfile**

```dockerfile
FROM node:18-alpine

# Install dependencies
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Copy source code
COPY . .

# Build the application
RUN npm run build

# Create non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S polkadot-sso -u 1001

# Create necessary directories
RUN mkdir -p /var/lib/polkadot-sso /var/log/polkadot-sso
RUN chown -R polkadot-sso:nodejs /var/lib/polkadot-sso /var/log/polkadot-sso

# Switch to non-root user
USER polkadot-sso

# Expose port
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3001/health || exit 1

# Start the application
CMD ["npm", "start"]
```

### **2. Create docker-compose.yml**

```yaml
version: '3.8'

services:
  polkadot-sso:
    build: .
    ports:
      - '3001:3001'
    environment:
      - NODE_ENV=production
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DATABASE_TYPE=postgresql
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=polkadot_sso
      - DATABASE_USERNAME=polkadot_sso
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REMITANCE_ENABLED=true
      - REMITANCE_TREASURY_ADDRESS=${REMITANCE_TREASURY_ADDRESS}
    depends_on:
      - postgres
    volumes:
      - ./logs:/var/log/polkadot-sso
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=polkadot_sso
      - POSTGRES_USER=polkadot_sso
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - polkadot-sso
    restart: unless-stopped

volumes:
  postgres_data:
```

### **3. Deploy with Docker**

```bash
# Create environment file
cp .env.example .env
# Edit .env with your production values

# Start services
docker-compose up -d

# Check logs
docker-compose logs -f polkadot-sso
```

---

## ☁️ **Cloud Deployment**

### **AWS Deployment**

#### **1. EC2 Instance Setup**

```bash
# Launch EC2 instance (t3.medium or larger)
# Install Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install PM2 for process management
sudo npm install -g pm2

# Clone and setup application
git clone https://github.com/your-org/polkadot-sso.git
cd polkadot-sso
npm install
npm run build
```

#### **2. RDS Database Setup**

```bash
# Create RDS PostgreSQL instance
# Note down connection details for environment variables
```

#### **3. PM2 Configuration**

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'polkadot-sso',
      script: 'packages/sso/dist/app.js',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3001,
        // ... other environment variables
      },
      error_file: '/var/log/polkadot-sso/err.log',
      out_file: '/var/log/polkadot-sso/out.log',
      log_file: '/var/log/polkadot-sso/combined.log',
      time: true,
    },
  ],
};
```

#### **4. Start with PM2**

```bash
# Start application
pm2 start ecosystem.config.js

# Save PM2 configuration
pm2 save
pm2 startup

# Monitor
pm2 monit
```

### **Google Cloud Platform**

#### **1. Cloud Run Deployment**

```yaml
# cloudbuild.yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/polkadot-sso', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/polkadot-sso']
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      [
        'run',
        'deploy',
        'polkadot-sso',
        '--image',
        'gcr.io/$PROJECT_ID/polkadot-sso',
        '--platform',
        'managed',
        '--region',
        'us-central1',
      ]
```

#### **2. Deploy**

```bash
# Build and deploy
gcloud builds submit --config cloudbuild.yaml

# Set environment variables
gcloud run services update polkadot-sso --set-env-vars="JWT_ACCESS_SECRET=your-secret"
```

---

## 🔒 **Security Considerations**

### **1. Network Security**

- Use HTTPS in production
- Configure proper CORS origins
- Set up rate limiting
- Use a reverse proxy (nginx/Apache)

### **2. Database Security**

- Use SSL connections
- Regular backups
- Access control
- Encryption at rest

### **3. Application Security**

- Keep dependencies updated
- Use strong secrets
- Enable all security features
- Regular security audits

### **4. Monitoring**

- Set up logging
- Monitor performance
- Alert on errors
- Track usage metrics

---

## 📊 **Monitoring & Observability**

### **1. Health Checks**

```bash
# Basic health check
curl http://localhost:3001/health

# Detailed status
curl http://localhost:3001/api/status
```

### **2. Logging**

```bash
# View logs
tail -f /var/log/polkadot-sso/app.log

# With PM2
pm2 logs polkadot-sso
```

### **3. Metrics**

```bash
# Enable metrics (if configured)
curl http://localhost:3001/metrics
```

---

## 🚨 **Troubleshooting**

### **Common Issues**

#### **1. Database Connection Issues**

```bash
# Check database connectivity
psql -h your-db-host -U your-db-user -d polkadot_sso

# Check environment variables
echo $DATABASE_HOST
echo $DATABASE_PORT
```

#### **2. RPC Connection Issues**

```bash
# Test RPC connectivity
curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "system_health"}' https://kusama-rpc.polkadot.io
```

#### **3. Memory Issues**

```bash
# Check memory usage
free -h
ps aux --sort=-%mem | head

# Increase Node.js memory limit
export NODE_OPTIONS="--max-old-space-size=2048"
```

### **Debug Mode**

```bash
# Enable debug logging
export LOG_LEVEL=debug
export NODE_ENV=development

# Start with debug
npm run dev
```

---

## 📈 **Performance Optimization**

### **1. Database Optimization**

- Use connection pooling
- Add proper indexes
- Regular VACUUM/ANALYZE

### **2. Caching**

- Enable Redis for session storage
- Cache exchange rates
- Use CDN for static assets

### **3. Load Balancing**

- Use multiple instances
- Configure sticky sessions
- Health check endpoints

---

## 🔄 **Updates & Maintenance**

### **1. Updating the Application**

```bash
# Pull latest changes
git pull origin main

# Install dependencies
npm install

# Run migrations (if any)
npm run migrate

# Restart application
pm2 restart polkadot-sso
```

### **2. Database Migrations**

```bash
# Run migrations
npm run migrate:up

# Rollback if needed
npm run migrate:down
```

### **3. Backup Strategy**

```bash
# Database backup
pg_dump polkadot_sso > backup_$(date +%Y%m%d_%H%M%S).sql

# Application backup
tar -czf polkadot-sso-backup-$(date +%Y%m%d_%H%M%S).tar.gz /var/lib/polkadot-sso
```

---

## 📞 **Support**

For production deployment support:

- **GitHub Issues**: Bug reports and feature requests
- **Discord**: Real-time community support
- **Email**: support@polkadot-auth.com

---

## 🎯 **Next Steps**

1. **Test thoroughly** in staging environment
2. **Set up monitoring** and alerting
3. **Configure backups** and disaster recovery
4. **Plan for scaling** as usage grows
5. **Stay updated** with new releases

**Happy Deploying! 🚀**
